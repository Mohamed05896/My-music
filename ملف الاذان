Ø§Ø±ÙŠØ¯ Ø¬Ø¹Ù„ Ù‡Ø§Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø´ØºØ§Ù„ ÙˆØ°ÙƒÙŠ ÙˆÙŠØ³ØªÙ‡Ù„Ùƒ Ø£Ù‚Ù„ ÙˆÙŠÙƒÙˆÙ† Ø¯Ø§Ø¦Ù…Ø§ Ø³Ø±ÙŠØ¹ 
import asyncio
import random
import aiohttp
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from pyrogram import filters
from pyrogram.types import Message
from motor.motor_asyncio import AsyncIOMotorClient

import config
from config import BANNED_USERS, COMMAND_PREFIXES, MONGO_DB_URI
from BrandrdXMusic import app
from BrandrdXMusic.utils.stream.stream import stream

# --- [ 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ] ---
db_client = AsyncIOMotorClient(MONGO_DB_URI)
azan_collection = db_client.BrandrdX.azan_final_db

OWNER_ID = 8313557781

# --- [ 2. Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø°ÙƒØ§Ø± ÙˆØ§Ù„Ø£Ø¯Ø¹ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ] ---
MORNING_DUAS = [
    "Ø§Ù„Ù„Ù‡Ù… Ø¨Ùƒ Ø£ØµØ¨Ø­Ù†Ø§ØŒ ÙˆØ¨Ùƒ Ø£Ù…Ø³ÙŠÙ†Ø§ØŒ ÙˆØ¨Ùƒ Ù†Ø­ÙŠØ§ØŒ ÙˆØ¨Ùƒ Ù†Ù…ÙˆØªØŒ ÙˆØ¥Ù„ÙŠÙƒ Ø§Ù„Ù†Ø´ÙˆØ±. â˜€ï¸",
    "Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ£ØµØ¨Ø­ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡ØŒ ÙˆØ§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ØŒ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡. âœ¨",
    "Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø®ÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…ØŒ ÙØªØ­Ù‡ØŒ ÙˆÙ†ØµØ±Ù‡ØŒ ÙˆÙ†ÙˆØ±Ù‡ØŒ ÙˆØ¨Ø±ÙƒØªÙ‡ØŒ ÙˆÙ‡Ø¯Ø§Ù‡. ğŸ¤²",
    "Ø±Ø¶ÙŠØª Ø¨Ø§Ù„Ù„Ù‡ Ø±Ø¨Ø§Ù‹ØŒ ÙˆØ¨Ø§Ù„Ø¥Ø³Ù„Ø§Ù… Ø¯ÙŠÙ†Ø§Ù‹ØŒ ÙˆØ¨Ù…Ø­Ù…Ø¯ ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ³Ù„Ù… Ù†Ø¨ÙŠØ§Ù‹. ğŸ¤",
    "ÙŠØ§ Ø­ÙŠ ÙŠØ§ Ù‚ÙŠÙˆÙ… Ø¨Ø±Ø­Ù…ØªÙƒ Ø£Ø³ØªØºÙŠØ«ØŒ Ø£ØµÙ„Ø­ Ù„ÙŠ Ø´Ø£Ù†ÙŠ ÙƒÙ„Ù‡ ÙˆÙ„Ø§ ØªÙƒÙ„Ù†ÙŠ Ø¥Ù„Ù‰ Ù†ÙØ³ÙŠ Ø·Ø±ÙØ© Ø¹ÙŠÙ†. ğŸ•Šï¸",
    "Ø§Ù„Ù„Ù‡Ù… Ø£Ù†Øª Ø±Ø¨ÙŠ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†ØªØŒ Ø®Ù„Ù‚ØªÙ†ÙŠ ÙˆØ£Ù†Ø§ Ø¹Ø¨Ø¯ÙƒØŒ ÙˆØ£Ù†Ø§ Ø¹Ù„Ù‰ Ø¹Ù‡Ø¯Ùƒ ÙˆÙˆØ¹Ø¯Ùƒ Ù…Ø§ Ø§Ø³ØªØ·Ø¹Øª. ğŸ›",
    "Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø¹Ù„Ù…Ø§Ù‹ Ù†Ø§ÙØ¹Ø§Ù‹ØŒ ÙˆØ±Ø²Ù‚Ø§Ù‹ Ø·ÙŠØ¨Ø§Ù‹ØŒ ÙˆØ¹Ù…Ù„Ø§Ù‹ Ù…ØªÙ‚Ø¨Ù„Ø§Ù‹. ğŸ“–",
    "Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ¶Ø± Ù…Ø¹ Ø§Ø³Ù…Ù‡ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ø£Ø±Ø¶ ÙˆÙ„Ø§ ÙÙŠ Ø§Ù„Ø³Ù…Ø§Ø¡ ÙˆÙ‡Ùˆ Ø§Ù„Ø³Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù„ÙŠÙ…. ğŸ›¡ï¸",
    "Ø§Ù„Ù„Ù‡Ù… Ø¹Ø§ÙÙ†ÙŠ ÙÙŠ Ø¨Ø¯Ù†ÙŠØŒ Ø§Ù„Ù„Ù‡Ù… Ø¹Ø§ÙÙ†ÙŠ ÙÙŠ Ø³Ù…Ø¹ÙŠØŒ Ø§Ù„Ù„Ù‡Ù… Ø¹Ø§ÙÙ†ÙŠ ÙÙŠ Ø¨ØµØ±ÙŠ. ğŸ©º",
    "Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø§Ù„Ø¹ÙÙˆ ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ© ÙÙŠ Ø¯ÙŠÙ†ÙŠ ÙˆØ¯Ù†ÙŠØ§ÙŠ ÙˆØ£Ù‡Ù„ÙŠ ÙˆÙ…Ø§Ù„ÙŠ. ğŸ€",
    "Ø£ØµØ¨Ø­Ù†Ø§ Ø¹Ù„Ù‰ ÙØ·Ø±Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŒ ÙˆØ¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ø®Ù„Ø§ØµØŒ ÙˆØ¹Ù„Ù‰ Ø¯ÙŠÙ† Ù†Ø¨ÙŠÙ†Ø§ Ù…Ø­Ù…Ø¯. ğŸŒ™",
    "Ø§Ù„Ù„Ù‡Ù… Ø§Ø¬Ø¹Ù„ ØµØ¨Ø§Ø­Ù†Ø§ Ù‡Ø°Ø§ ØµØ¨Ø§Ø­Ø§Ù‹ Ù…Ø¨Ø§Ø±ÙƒØ§Ù‹ØŒ ØªÙØªØ­ Ù„Ù†Ø§ ÙÙŠÙ‡ Ø£Ø¨ÙˆØ§Ø¨ Ø±Ø­Ù…ØªÙƒ. ğŸšª",
    "Ø±Ø¨ÙŠ Ø£Ø³Ø£Ù„Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØµØ¨Ø§Ø­ Ø£Ù† ØªØ±ÙŠØ­ Ù‚Ù„Ø¨ÙŠ ÙˆÙÙƒØ±ÙŠ. ğŸ§˜",
    "Ø­Ø³Ø¨ÙŠ Ø§Ù„Ù„Ù‡ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ù‡ÙˆØŒ Ø¹Ù„ÙŠÙ‡ ØªÙˆÙƒÙ„Øª ÙˆÙ‡Ùˆ Ø±Ø¨ Ø§Ù„Ø¹Ø±Ø´ Ø§Ù„Ø¹Ø¸ÙŠÙ…. â›°ï¸"
]

# --- [ 3. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù…Ù„ØµÙ‚Ø§Øª) ] ---
AZAN_RESOURCES = {
    "Fajr": {"name": "Ø§Ù„ÙØ¬Ø±", "vidid": "r9AWBlpantg", "link": "https://youtu.be/watch?v=r9AWBlpantg", "sticker": "CAACAgQAAyEFAATHCHTJAAIJD2lOq8aLkRR49evBKiITWWhwtgEoAALoGgACp_FYUQuzqVH-JHS5HgQ"},
    "Dhuhr": {"name": "Ø§Ù„Ø¸Ù‡Ø±", "vidid": "21MuvFr7CK8", "link": "https://www.youtube.com/watch?v=21MuvFr7CK8", "sticker": "CAACAgQAAyEFAATHCHTJAAIJEWlOrFKzjSDZeWfl6U3F-lrKldRXAAJMGwACMVlYUa15CORC0p0xHgQ"},
    "Asr": {"name": "Ø§Ù„Ø¹ØµØ±", "vidid": "bb6cNncMdiM", "link": "https://www.youtube.com/watch?v=bb6cNncMdiM", "sticker": "CAACAgQAAyEFAATHCHTJAAIJE2lOrFRQIbcdLfnpdl5PtbdqNyR6AALFGQAC3ZZRUcK5YivXbwUAAR4E"},
    "Maghrib": {"name": "Ø§Ù„Ù…ØºØ±Ø¨", "vidid": "hKPcNh7WHoM", "link": "https://youtu.be/watch?v=hKPcNh7WHoM", "sticker": "CAACAgQAAyEFAATHCHTJAAIJFWlOrFT4eOnPJDsSuU6Ya-V0WPQdAALfFwACcIVQUX6NcNNCxvdRHgQ"},
    "Isha": {"name": "Ø§Ù„Ø¹Ø´Ø§Ø¡", "vidid": "hKPcNh7WHoM", "link": "https://youtu.be/watch?v=hKPcNh7WHoM", "sticker": "CAACAgQAAyEFAATHCHTJAAIJF2lOrFVxhRGefHki3d4s-hLC9cKHAALqHAAC3oZQUWqQdvdwXnGLHgQ"}
}

# --- [ 4. ÙˆØ¸Ø§Ø¦Ù Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ ] ---

async def get_azan_times():
    url = "http://api.aladhan.com/v1/timingsByCity?city=Cairo&country=Egypt&method=5"
    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(url) as response:
                if response.status == 200:
                    res_json = await response.json()
                    return res_json["data"]["timings"]
    except:
        return None

async def start_azan_stream(chat_id, prayer_key):
    res = AZAN_RESOURCES[prayer_key]
    fake_result = {
        "link": res["link"], 
        "vidid": res["vidid"], 
        "title": f"Ø£Ø°Ø§Ù† {res['name']}", 
        "duration_min": "05:00", 
        "thumb": f"https://img.youtube.com/vi/{res['vidid']}/hqdefault.jpg"
    }
    _ = {"queue_4": "<b>ğŸ”¢ Ø§Ù„ØªØ±ØªÙŠØ¨: #{}</b>", "stream_1": "<b>ğŸ”˜ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...</b>", "play_3": "<b>âŒ ÙØ´Ù„.</b>"}
    try:
        await app.send_sticker(chat_id, res["sticker"])
        caption = f"<b>Ø­Ø§Ù† Ø§Ù„Ø¢Ù† Ù…ÙˆØ¹Ø¯ Ø§Ø°Ø§Ù† {res['name']}</b>\n<b>Ø¨Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ù‡Ø±Ù‡ ğŸ•ŒğŸ¤</b>"
        mystic = await app.send_message(chat_id, caption)
        await stream(_, mystic, app.id, fake_result, chat_id, "Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø°Ø§Ù†", chat_id, video=False, streamtype="youtube", forceplay=True)
    except:
        pass

async def broadcast_azan(prayer_key):
    async for entry in azan_collection.find({"azan_active": True}):
        c_id = entry.get("chat_id")
        if c_id:
            await start_azan_stream(c_id, prayer_key)
            await asyncio.sleep(3)

async def update_azan_scheduler():
    times = await get_azan_times()
    if not times:
        return
    for job in scheduler.get_jobs():
        if job.id.startswith("azan_"):
            job.remove()
    for key in AZAN_RESOURCES.keys():
        h, m = map(int, times[key].split(":"))
        scheduler.add_job(broadcast_azan, "cron", hour=h, minute=m, args=[key], id=f"azan_{key}")

async def send_morning_dua():
    dua = random.choice(MORNING_DUAS)
    text = f"<b>â˜€ï¸ Ø¯Ø¹Ø§Ø¡ Ø§Ù„ØµØ¨Ø§Ø­</b>\n\n{dua}\n\n<b>ØµØ¨Ø§Ø­ÙƒÙ… Ø·Ø§Ø¹Ø© ÙˆØ±Ø¶Ø§ âœ¨</b>"
    async for entry in azan_collection.find({"dua_active": True}):
        try:
            chat_id = entry.get("chat_id")
            if chat_id:
                await app.send_message(chat_id, text)
                await asyncio.sleep(2)
        except:
            continue

# --- [ 5. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ ] ---
scheduler = AsyncIOScheduler(timezone="Africa/Cairo")
scheduler.add_job(update_azan_scheduler, "cron", hour=0, minute=5)
scheduler.add_job(send_morning_dua, "cron", hour=7, minute=0)

if not scheduler.running:
    scheduler.start()
    asyncio.get_event_loop().create_task(update_azan_scheduler())

# --- [ 6. Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ­ÙƒÙ… ] ---

@app.on_message(filters.command(["ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø°Ø§Ù†"], COMMAND_PREFIXES) & filters.group & ~BANNED_USERS)
async def azan_on(_, message: Message):
    await azan_collection.update_one({"chat_id": message.chat.id}, {"$set": {"azan_active": True}}, upsert=True)
    await message.reply_text("<b>ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø°Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ğŸ¤</b>")

@app.on_message(filters.command(["Ù‚ÙÙ„ Ø§Ù„Ø§Ø°Ø§Ù†"], COMMAND_PREFIXES) & filters.group & ~BANNED_USERS)
async def azan_off(_, message: Message):
    await azan_collection.update_one({"chat_id": message.chat.id}, {"$set": {"azan_active": False}}, upsert=True)
    await message.reply_text("<b>âŒ ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø£Ø°Ø§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.</b>")

@app.on_message(filters.command(["ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø¹Ø§Ø¡"], COMMAND_PREFIXES) & filters.group & ~BANNED_USERS)
async def dua_on(_, message: Message):
    await azan_collection.update_one({"chat_id": message.chat.id}, {"$set": {"dua_active": True}}, upsert=True)
    await message.reply_text("<b>âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø£Ø¯Ø¹ÙŠØ© Ø§Ù„ØµØ¨Ø§Ø­ (7:00 Øµ).</b>")

@app.on_message(filters.command(["Ù‚ÙÙ„ Ø§Ù„Ø¯Ø¹Ø§Ø¡"], COMMAND_PREFIXES) & filters.group & ~BANNED_USERS)
async def dua_off(_, message: Message):
    await azan_collection.update_one({"chat_id": message.chat.id}, {"$set": {"dua_active": False}}, upsert=True)
    await message.reply_text("<b>âŒ ØªÙ… Ù‚ÙÙ„ Ø£Ø¯Ø¹ÙŠØ© Ø§Ù„ØµØ¨Ø§Ø­.</b>")

@app.on_message(filters.command("ØªØ³Øª Ø§Ø°Ø§Ù†", COMMAND_PREFIXES) & filters.user(OWNER_ID))
async def test_a(_, message: Message):
    await start_azan_stream(message.chat.id, "Fajr")
